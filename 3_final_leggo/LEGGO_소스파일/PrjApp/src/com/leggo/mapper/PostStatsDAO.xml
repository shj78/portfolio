<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="com.leggo.mybatis.IPostStatsDAO">

	<select id="postCount" resultType="com.leggo.mybatis.PostStatsDTO">
		SELECT PH.COUNT AS PHOTO, P.COUNT AS PLAN, T.COUNT AS TRIP
		FROM 
		(
			SELECT COUNT(*) AS COUNT
			FROM PHOTO_POST
			WHERE TO_CHAR(PP_DT, 'YYYY-MM-DD') = TO_CHAR(SYSDATE, 'YYYY-MM-DD')
		) PH,
		(
			SELECT COUNT(*) AS COUNT
			FROM PLAN
			WHERE TO_CHAR(PL_DT, 'YYYY-MM-DD') = TO_CHAR(SYSDATE, 'YYYY-MM-DD')
		) P,
		(
			SELECT COUNT(*) AS COUNT
			FROM TRIP
			WHERE TO_CHAR(TR_DT, 'YYYY-MM-DD') = TO_CHAR(SYSDATE, 'YYYY-MM-DD')
		) T
	</select>
	
	<select id="postDayCount" resultType="com.leggo.mybatis.PostStatsDTO">
		SELECT A.DAY AS DT, (NVL(B.COUNT, 0)+NVL(C.COUNT, 0)+NVL(D.COUNT, 0)) AS COUNT
		FROM 
		(
			SELECT TO_CHAR(SYSDATE-LEVEL+1, 'YYYY-MM-DD') DAY
			FROM DUAL
			CONNECT BY LEVEL BETWEEN 1 AND 7
		) A
		,(
			SELECT TO_CHAR(PP_DT, 'YYYY-MM-DD') AS DAY, COUNT(*) AS COUNT
			FROM PHOTO_POST
			WHERE TO_CHAR(PP_DT, 'YYYY-MM-DD') BETWEEN TO_CHAR(SYSDATE-6, 'YYYY-MM-DD') AND TO_CHAR(SYSDATE, 'YYYY-MM-DD')
			GROUP BY TO_CHAR(PP_DT, 'YYYY-MM-DD')
		) B
		,(
			SELECT TO_CHAR(PL_DT, 'YYYY-MM-DD') AS DAY, COUNT(*) AS COUNT
			FROM PLAN
			WHERE TO_CHAR(PL_DT, 'YYYY-MM-DD') BETWEEN TO_CHAR(SYSDATE-6, 'YYYY-MM-DD') AND TO_CHAR(SYSDATE, 'YYYY-MM-DD')
			GROUP BY TO_CHAR(PL_DT, 'YYYY-MM-DD')
		) C
		,(
			SELECT TO_CHAR(TR_DT, 'YYYY-MM-DD') AS DAY, COUNT(*) AS COUNT
			FROM TRIP
			WHERE TO_CHAR(TR_DT, 'YYYY-MM-DD') BETWEEN TO_CHAR(SYSDATE-6, 'YYYY-MM-DD') AND TO_CHAR(SYSDATE, 'YYYY-MM-DD')
			GROUP BY TO_CHAR(TR_DT, 'YYYY-MM-DD')
		) D
		WHERE A.DAY = B.DAY(+) AND A.DAY = C.DAY(+) AND A.DAY = D.DAY(+) 
		ORDER BY A.DAY
	</select>
	
	<select id="totCount" resultType="com.leggo.mybatis.PostStatsDTO">
		SELECT A.DAY AS DT, NVL(B.COUNT, 0) AS PLAN, NVL(C.COUNT, 0) AS TRIP, NVL(D.COUNT, 0) AS PHOTO
		FROM 
		(
			SELECT TO_CHAR(SYSDATE-LEVEL+1, 'YYYY-MM-DD') DAY
			FROM DUAL
			CONNECT BY LEVEL BETWEEN 1 AND 14
		) A
		, (
			SELECT TO_CHAR(PL_DT, 'YYYY-MM-DD') AS DAY, COUNT(*) AS COUNT
			FROM PLAN
			WHERE TO_CHAR(PL_DT, 'YYYY-MM-DD') BETWEEN TO_CHAR(SYSDATE-13, 'YYYY-MM-DD') AND TO_CHAR(SYSDATE, 'YYYY-MM-DD')
			GROUP BY TO_CHAR(PL_DT, 'YYYY-MM-DD')
		) B
		, (
			SELECT TO_CHAR(TR_DT, 'YYYY-MM-DD') AS DAY, COUNT(*) AS COUNT
			FROM TRIP
			WHERE TO_CHAR(TR_DT, 'YYYY-MM-DD') BETWEEN TO_CHAR(SYSDATE-13, 'YYYY-MM-DD') AND TO_CHAR(SYSDATE, 'YYYY-MM-DD')
			GROUP BY TO_CHAR(TR_DT, 'YYYY-MM-DD')
		) C
		, (
			SELECT TO_CHAR(PP_DT, 'YYYY-MM-DD') AS DAY, COUNT(*) AS COUNT
			FROM PHOTO_POST
			WHERE TO_CHAR(PP_DT, 'YYYY-MM-DD') BETWEEN TO_CHAR(SYSDATE-13, 'YYYY-MM-DD') AND TO_CHAR(SYSDATE, 'YYYY-MM-DD')
			GROUP BY TO_CHAR(PP_DT, 'YYYY-MM-DD')
		) D
		WHERE A.DAY = B.DAY(+) AND A.DAY = C.DAY(+) AND A.DAY = D.DAY(+)
		ORDER BY A.DAY DESC
	</select>
	
</mapper>
